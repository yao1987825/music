<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>GitHubéŸ³ä¹æ’­æ”¾å™¨ - ä»…æ’­æ”¾æœ¬åœ°æ–‡ä»¶</title>
    <style>
        /* ====================================
           åŸºç¡€å’Œæ’­æ”¾å™¨æ ·å¼
           ==================================== */
        body { 
            display: flex; 
            justify-content: center; 
            align-items: center; 
            min-height: 100vh; 
            margin: 0; 
            background-color: #f0f0f0; 
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            color: #333;
        }
        .player-container { 
            width: 380px; 
            background-color: #fff; 
            border-radius: 12px; 
            box-shadow: 0 6px 15px rgba(0, 0, 0, 0.1); 
            padding: 25px; /* å¢åŠ å†…è¾¹è· */
            box-sizing: border-box; /* ç¡®ä¿å†…è¾¹è·ä¸å¢åŠ å®½åº¦ */
        }
        .current-song { text-align: center; margin-bottom: 20px; }
        #current-title { font-size: 1.6em; font-weight: bold; color: #333; margin-bottom: 8px; }
        #current-artist { font-size: 1.1em; color: #d32f2f; min-height: 1.4em; }
        audio { width: 100%; margin-bottom: 15px; outline: none; border-radius: 5px; }

        /* ====================================
           æ§åˆ¶æŒ‰é’®æ ·å¼
           ==================================== */
        .controls-row {
            display: flex;
            justify-content: space-around;
            align-items: center;
            margin-bottom: 20px;
            padding: 0 5px;
        }
        .control-button {
            background: none;
            border: none;
            color: #666;
            cursor: pointer;
            font-size: 1.6em; /* ç•¥å¾®å¢å¤§ */
            width: 40px; /* ç»Ÿä¸€æŒ‰é’®å®½åº¦ */
            height: 40px; /* ç»Ÿä¸€æŒ‰é’®é«˜åº¦ */
            display: flex;
            justify-content: center;
            align-items: center;
            border-radius: 50%; /* åœ†å½¢æŒ‰é’® */
            transition: color 0.2s, background-color 0.2s, transform 0.1s;
        }
        .control-button:hover {
            color: #333;
            background-color: #f0f0f0;
        }
        .control-button.active {
            color: #00796b; 
            background-color: #e0f7fa;
        }
        .control-button.active:hover {
            color: #004d40;
            background-color: #c2e7ff;
        }
        /* ç®€å•å›¾æ ‡æ¨¡æ‹Ÿ */
        .icon-shuffle::before { content: 'ğŸ”€'; }
        .icon-loop-all::before { content: 'ğŸ”'; }
        .icon-loop-one::before { content: 'ğŸ”‚'; }
        .icon-prev::before { content: 'â®ï¸'; font-size: 1.3em; } /* è°ƒæ•´å¤§å° */
        .icon-next::before { content: 'â­ï¸'; font-size: 1.3em; } /* è°ƒæ•´å¤§å° */

        /* æ¨¡å¼æ˜¾ç¤ºå±…ä¸­ */
        .mode-status {
            flex-grow: 1;
            text-align: center;
            color: #666; 
            font-size: 0.95em;
            padding: 0 10px;
        }

        /* ====================================
           æ­Œè¯/æœç´¢/åˆ—è¡¨æ ·å¼
           ==================================== */
        #search-input { width: calc(100% - 22px); padding: 10px; margin-bottom: 15px; border: 1px solid #ccc; border-radius: 8px; box-sizing: border-box; font-size: 1em; }
        #search-input::placeholder { color: #aaa; }
        .playlist-header { font-size: 1.2em; font-weight: 600; color: #444; border-bottom: 2px solid #eee; padding-bottom: 10px; margin-bottom: 10px; }
        .lyrics-box { height: 160px; overflow-y: auto; border: 1px solid #ddd; border-radius: 8px; padding: 10px; margin-bottom: 20px; background-color: #fafafa; text-align: center; font-size: 0.95em; line-height: 1.5; }
        .lyrics-box p { margin: 0; padding: 0; } /* ç§»é™¤é»˜è®¤æ®µè½è¾¹è· */
        .lyrics-line { padding: 4px 0; color: #666; transition: color 0.2s, font-weight 0.2s, font-size 0.2s; }
        .lyrics-line.current { color: #00796b; font-weight: bold; font-size: 1em; }
        .lyrics-line.current-scroll { scroll-margin-top: 60px; } /* æ»šåŠ¨ä¸­å¿ƒåç§» */
        .playlist { list-style: none; padding: 0; max-height: 280px; overflow-y: auto; border-radius: 8px; border: 1px solid #eee; } /* å¢åŠ è¾¹æ¡† */
        .playlist-item { padding: 12px 15px; border-bottom: 1px solid #f9f9f9; cursor: pointer; transition: background-color 0.2s; }
        .playlist-item:last-child { border-bottom: none; }
        .playlist-item:hover { background-color: #f7f7f7; }
        .playlist-item.active { background-color: #e0f7fa; font-weight: bold; color: #00796b; }
        .song-title-display { color: #333; }
        .playlist-item.active .song-title-display { color: #00796b; }
        .song-artist-display { font-size: 0.9em; color: #777; font-weight: normal; margin-left: 8px; }
        .playlist-item.active .song-artist-display { color: #00796b; }
    </style>
</head>
<body>

<div class="player-container">
    <div class="current-song">
        <div id="current-title">åŠªåŠ›åŠ è½½ä¸­...</div>
        <div id="current-artist">æ­£åœ¨è¿æ¥ GitHub APIï¼Œè¯·ç¨å€™</div>
    </div>

    <audio controls id="audio-player" preload="metadata"></audio>
    
    <div class="controls-row">
        <button id="shuffle-btn" class="control-button icon-shuffle" title="éšæœºæ’­æ”¾"></button>
        <button id="prev-btn" class="control-button icon-prev" title="ä¸Šä¸€é¦–"></button>
        
        <div id="mode-display" class="mode-status">åˆ—è¡¨å¾ªç¯</div>
        
        <button id="next-btn" class="control-button icon-next" title="ä¸‹ä¸€é¦–"></button>
        <button id="loop-btn" class="control-button icon-loop-all" title="åˆ‡æ¢å¾ªç¯æ¨¡å¼"></button>
    </div>
    
    <div class="lyrics-box" id="lyrics-box">
        <p style="color:#999; text-align: center;">æ­Œè¯æ­£åœ¨åŠ è½½æˆ–æš‚æ— æ­Œè¯...</p>
    </div>

    <input 
        type="text" 
        id="search-input" 
        placeholder="è¾“å…¥å…³é”®å­—è¿›è¡Œæ¨¡ç³Šæœç´¢ (å¦‚: å”¯ä¸€ é‚“ç´«æ£‹)" 
        >

    <div class="playlist-header">æ­Œæ›²åˆ—è¡¨</div>
    <ul class="playlist" id="playlist">
        <li style="padding: 10px; color: #00796b; text-align: center;">æ­£åœ¨è·å–æ­Œæ›²åˆ—è¡¨...</li>
    </ul>
</div>

<script>
    // ====================================================
    // 1. å¸¸é‡å’ŒçŠ¶æ€å®šä¹‰
    // ====================================================
    
    const REPO_OWNER = 'yao1987825';
    const REPO_NAME = 'music'; // æ‚¨çš„å®é™…ä»“åº“å
    const GITHUB_MAIN_BRANCH = 'main'; 
    
    // GitHub æ–‡ä»¶è·¯å¾„å¸¸é‡
    const BASE_RAW_URL = `https://raw.githubusercontent.com/${REPO_OWNER}/${REPO_NAME}/${GITHUB_MAIN_BRANCH}/downloads/`;
    const GITHUB_API_URL = `https://api.github.com/repos/${REPO_OWNER}/${REPO_NAME}/contents/downloads`;
    const SUPPORTED_EXTENSIONS = ['.mp3', '.flac', '.wav', '.ogg']; // å¢åŠ æ›´å¤šå¯èƒ½çš„éŸ³é¢‘æ ¼å¼
    
    // DOM å…ƒç´ 
    const audioPlayer = document.getElementById('audio-player');
    const playlistElement = document.getElementById('playlist');
    const currentTitleElement = document.getElementById('current-title');
    const currentArtistElement = document.getElementById('current-artist');
    const searchInput = document.getElementById('search-input');
    const lyricsBox = document.getElementById('lyrics-box');
    const shuffleBtn = document.getElementById('shuffle-btn');
    const loopBtn = document.getElementById('loop-btn');
    const prevBtn = document.getElementById('prev-btn');
    const nextBtn = document.getElementById('next-btn');
    const modeDisplay = document.getElementById('mode-display');

    // çŠ¶æ€å˜é‡
    let KnownTracks = []; 
    let currentTrackFullFileName = ''; 
    let isListLoaded = false; 
    let lyricsData = []; 
    let currentLyricIndex = -1; 
    let playMode = 'default'; // 'default' (åˆ—è¡¨å¾ªç¯), 'loop-one' (å•æ›²å¾ªç¯), 'shuffle' (éšæœºæ’­æ”¾)
    let searchTimeout; // ç”¨äº Debounce æœç´¢çš„è®¡æ—¶å™¨


    // ====================================================
    // 2. æ ¸å¿ƒè¾…åŠ©å‡½æ•°
    // ====================================================

    function buildUrl(fullFileName) {
        const encodedFullFileName = encodeURIComponent(fullFileName);
        return `${BASE_RAW_URL}${encodedFullFileName}`;
    }

    function parseFileName(fullFileName) {
        let title = fullFileName;
        let artist = "æœªçŸ¥æ­Œæ‰‹";
        let extension = '';

        for (const ext of SUPPORTED_EXTENSIONS) {
            if (fullFileName.toLowerCase().endsWith(ext)) {
                extension = ext;
                break;
            }
        }
        
        const cleanName = extension ? fullFileName.slice(0, -extension.length).trim() : fullFileName;

        if (cleanName.includes(' - ')) {
            const parts = cleanName.split(' - ');
            title = parts[0].trim();
            artist = parts.slice(1).join(' - ').trim(); 
        } else {
            title = cleanName;
            artist = "ï¼ˆæ–‡ä»¶ååŒ¹é…ï¼‰";
        }
        
        return {
            fileName: cleanName,        
            fullFileName: fullFileName, 
            title: title,       
            artist: artist,
            extension: extension
        };
    }
    
    function updatePlaylistHighlight(fullFileName) {
        const items = playlistElement.getElementsByClassName('playlist-item');
        for (let i = 0; i < items.length; i++) {
            const item = items[i];
            item.classList.remove('active');
            if (item.getAttribute('data-fullfilename') === fullFileName) {
                item.classList.add('active');
                item.scrollIntoView({ behavior: 'smooth', block: 'center' });
            }
        }
    }
    
    function getCurrentTrackIndex() {
        return KnownTracks.findIndex(track => track.fullFileName === currentTrackFullFileName);
    }
    
    // ====================================================
    // 3. æ’­æ”¾æ¨¡å¼æ§åˆ¶å‡½æ•°
    // ====================================================

    function toggleLoopMode() {
        if (playMode === 'loop-one') {
            playMode = shuffleBtn.classList.contains('active') ? 'shuffle' : 'default';
        } else {
            playMode = 'loop-one';
        }
        updateControlsDisplay();
    }

    function toggleShuffleMode() {
        shuffleBtn.classList.toggle('active');
        if (shuffleBtn.classList.contains('active')) {
            playMode = 'shuffle';
        } else {
            playMode = loopBtn.classList.contains('icon-loop-one') && loopBtn.classList.contains('active') ? 'loop-one' : 'default';
        }
        updateControlsDisplay();
    }
    
    function updateControlsDisplay() {
        if (playMode === 'loop-one') {
            loopBtn.className = 'control-button icon-loop-one active';
            loopBtn.title = 'å½“å‰ï¼šå•æ›²å¾ªç¯';
            audioPlayer.loop = true; 
        } else {
            loopBtn.className = 'control-button icon-loop-all'; 
            loopBtn.title = 'åˆ—è¡¨å¾ªç¯ / åˆ‡æ¢å•æ›²å¾ªç¯';
            audioPlayer.loop = false; 
        }

        shuffleBtn.classList.toggle('active', playMode === 'shuffle');
        shuffleBtn.title = playMode === 'shuffle' ? 'å½“å‰ï¼šéšæœºæ’­æ”¾' : 'åˆ‡æ¢éšæœºæ’­æ”¾';

        if (playMode === 'loop-one') {
            modeDisplay.textContent = 'å•æ›²å¾ªç¯';
        } else if (playMode === 'shuffle') {
            modeDisplay.textContent = 'éšæœºæ’­æ”¾';
        } else {
            modeDisplay.textContent = 'åˆ—è¡¨å¾ªç¯';
        }
    }

    function getNextTrackIndex(currentIndex) {
        if (KnownTracks.length === 0) return -1;
        
        if (playMode === 'shuffle') {
            if (KnownTracks.length <= 1) return currentIndex; 
            let nextIndex;
            do {
                nextIndex = Math.floor(Math.random() * KnownTracks.length);
            } while (nextIndex === currentIndex); 
            return nextIndex;
        }

        let nextIndex = currentIndex + 1;
        if (nextIndex >= KnownTracks.length) {
            return 0; 
        }
        
        return nextIndex;
    }
    
    function getPrevTrackIndex(currentIndex) {
        if (KnownTracks.length === 0) return -1;
        
        if (playMode === 'shuffle') {
            return getNextTrackIndex(currentIndex);
        }

        let prevIndex = currentIndex - 1;
        if (prevIndex < 0) {
            return KnownTracks.length - 1; 
        }
        
        return prevIndex;
    }


    // ====================================================
    // 4. æ­Œè¯å¤„ç†å‡½æ•°
    // ====================================================

    function timeToSeconds(timeString) {
        const parts = timeString.split(':');
        return (parseFloat(parts[0]) * 60) + parseFloat(parts[1]);
    }

    function parseLRC(lrcText) {
        const lines = lrcText.split('\n');
        const data = [];
        const timeTagRegex = /\[(\d{2}:\d{2}(?:\.\d{2,3})?)\]/g; 

        for (const line of lines) {
            let match;
            let lastIndex = 0;
            const timeTags = [];
            
            while ((match = timeTagRegex.exec(line)) !== null) {
                timeTags.push(match[1]); 
                lastIndex = timeTagRegex.lastIndex;
            }

            const text = line.substring(lastIndex).trim();
            
            if (text && timeTags.length > 0) {
                for (const timeTag of timeTags) {
                    data.push({ time: timeToSeconds(timeTag), text: text });
                }
            } else if (text && timeTags.length === 0) {
                data.push({ time: 0, text: text });
            }
        }
        data.sort((a, b) => a.time - b.time);
        
        if (data.length > 0 && data.every(item => item.time === 0)) {
            return [{ time: 0, text: data.map(item => item.text).join('<br>') }];
        }
        return data;
    }
    
    function fetchLyrics(cleanName) {
        lyricsBox.innerHTML = '<p style="color:#999;">æ­£åœ¨åŠ è½½æ­Œè¯...</p>';
        lyricsData = [];
        currentLyricIndex = -1;

        const encodedFileName = encodeURIComponent(cleanName);
        const lrcUrl = `${BASE_RAW_URL}${encodedFileName}.lrc`;

        fetch(lrcUrl)
            .then(response => {
                if (response.ok) {
                    return response.text();
                } else {
                    const txtUrl = `${BASE_RAW_URL}${encodedFileName}.txt`;
                    return fetch(txtUrl).then(resp => {
                        if (resp.ok) return resp.text();
                        throw new Error('No lyrics file found.');
                    });
                }
            })
            .then(lyricsText => {
                if (!lyricsText.trim()) {
                    lyricsBox.innerHTML = '<p style="color:#999;">æ­Œè¯æ–‡ä»¶ä¸ºç©ºã€‚</p>';
                    return;
                }
                lyricsData = parseLRC(lyricsText);
                
                if (lyricsData.length > 0) {
                    renderLyricsHTML();
                } else {
                    lyricsBox.innerHTML = '<p style="color:#999;">æ­Œè¯è§£æå¤±è´¥æˆ–æ–‡ä»¶æ ¼å¼ä¸æ­£ç¡®ã€‚</p>';
                }
            })
            .catch(error => {
                console.warn(`è·å–æ­Œè¯å¤±è´¥ (${cleanName}):`, error);
                lyricsBox.innerHTML = '<p style="color:#999;">æš‚æ— æ­Œè¯æ–‡ä»¶ (.lrc æˆ– .txt)ã€‚</p>';
            });
    }

    function renderLyricsHTML() {
        lyricsBox.innerHTML = ''; 
        if (lyricsData.length === 0) {
            lyricsBox.innerHTML = '<p style="color:#999;">æ— æ­Œè¯ã€‚</p>';
            return;
        }

        if (lyricsData.length === 1 && lyricsData[0].time === 0 && lyricsData[0].text.includes('<br>')) {
            lyricsBox.innerHTML = `<p class="lyrics-line current" style="color:#333; white-space: pre-wrap;">${lyricsData[0].text}</p>`;
        } else {
            lyricsData.forEach((line, index) => {
                const p = document.createElement('p');
                p.className = 'lyrics-line';
                p.textContent = line.text;
                p.setAttribute('data-index', index);
                lyricsBox.appendChild(p);
            });
        }
    }

    function syncLyrics() {
        if (lyricsData.length === 0 || audioPlayer.paused || audioPlayer.currentTime === 0) return;
        if (lyricsData.length === 1 && lyricsData[0].time === 0) { 
             return;
        }

        const currentTime = audioPlayer.currentTime + 0.3; 
        let nextIndex = currentLyricIndex;

        while (nextIndex + 1 < lyricsData.length && lyricsData[nextIndex + 1].time <= currentTime) {
            nextIndex++;
        }
        while (nextIndex > 0 && lyricsData[nextIndex].time > currentTime) {
            nextIndex--;
        }

        if (nextIndex !== currentLyricIndex) {
            const lines = lyricsBox.querySelectorAll('.lyrics-line');
            
            if (currentLyricIndex >= 0 && lines[currentLyricIndex]) {
                lines[currentLyricIndex].classList.remove('current', 'current-scroll');
            }

            if (nextIndex >= 0 && lines[nextIndex]) {
                lines[nextIndex].classList.add('current', 'current-scroll');
                lines[nextIndex].scrollIntoView({ behavior: 'smooth', block: 'center' });
            }

            currentLyricIndex = nextIndex;
        }
    }


    // ====================================================
    // 5. ä¸»è¦æ’­æ”¾æ“ä½œå‡½æ•°
    // ====================================================

    function loadAndPlayTrack(track) { 
        if (!track) {
            console.error("å°è¯•åŠ è½½ç©ºè½¨é“ã€‚");
            return;
        }
        
        const url = buildUrl(track.fullFileName); 
        currentTrackFullFileName = track.fullFileName;
        
        audioPlayer.src = url;
        audioPlayer.load(); 
        
        currentTitleElement.textContent = track.title;
        currentArtistElement.textContent = track.artist;

        fetchLyrics(track.fileName); 

        audioPlayer.play().catch(error => {
            console.warn("æ’­æ”¾å¤±è´¥æˆ–è‡ªåŠ¨æ’­æ”¾è¢«é˜»æ­¢ã€‚è¯·æ‰‹åŠ¨ç‚¹å‡»æ’­æ”¾ã€‚", error);
            currentArtistElement.textContent = `[${track.artist}] è‡ªåŠ¨æ’­æ”¾å¤±è´¥ï¼Œè¯·ç‚¹å‡»æ’­æ”¾æŒ‰é’®`;
            audioPlayer.volume = 0; 
            setTimeout(() => audioPlayer.volume = 1, 500); 
        });

        updatePlaylistHighlight(track.fullFileName);
    }

    function playNextTrack() {
        if (KnownTracks.length === 0) {
            currentTitleElement.textContent = "æ— æ­Œæ›²";
            currentArtistElement.textContent = "è¯·ä¸Šä¼ æ­Œæ›²æˆ–æ£€æŸ¥é…ç½®";
            currentTrackFullFileName = '';
            updatePlaylistHighlight('');
            return;
        }
        
        const currentIndex = getCurrentTrackIndex();
        const nextIndex = getNextTrackIndex(currentIndex);
        
        if (nextIndex >= 0) {
            loadAndPlayTrack(KnownTracks[nextIndex]);
        } else {
            currentTitleElement.textContent = "æ’­æ”¾ç»“æŸ";
            currentArtistElement.textContent = "è¯·é‡æ–°é€‰æ‹©æ­Œæ›²";
            currentTrackFullFileName = '';
            updatePlaylistHighlight('');
        }
    }
    
    function playPrevTrack() {
        if (KnownTracks.length === 0) {
            currentTitleElement.textContent = "æ— æ­Œæ›²";
            currentArtistElement.textContent = "è¯·ä¸Šä¼ æ­Œæ›²æˆ–æ£€æŸ¥é…ç½®";
            currentTrackFullFileName = '';
            updatePlaylistHighlight('');
            return;
        }
        
        if (audioPlayer.currentTime > 3 || playMode === 'shuffle') {
            if (playMode === 'shuffle') {
                 playNextTrack(); 
                 return;
            }
            audioPlayer.currentTime = 0; 
            audioPlayer.play();
            return;
        }
        
        const currentIndex = getCurrentTrackIndex();
        const prevIndex = getPrevTrackIndex(currentIndex);
        
        if (prevIndex >= 0) {
            loadAndPlayTrack(KnownTracks[prevIndex]);
        }
    }


    // ====================================================
    // 6. æœç´¢åŠŸèƒ½
    // ====================================================
    
    /** æ¸²æŸ“æœç´¢ç»“æœåˆ—è¡¨ */
    function renderSearchResults(searchTerm) {
        playlistElement.innerHTML = ''; 
        
        if (!isListLoaded) {
            playlistElement.innerHTML = '<li style="padding: 10px; color: #00796b; text-align: center;">åˆ—è¡¨å°šæœªåŠ è½½å®Œæˆ...</li>';
            return;
        }

        const lowerCaseSearchTerm = searchTerm.toLowerCase().trim();
        let tracksToRender = KnownTracks;

        if (lowerCaseSearchTerm) {
            tracksToRender = KnownTracks.filter(track => {
                return track.title.toLowerCase().includes(lowerCaseSearchTerm) ||
                       track.artist.toLowerCase().includes(lowerCaseSearchTerm) ||
                       track.fileName.toLowerCase().includes(lowerCaseSearchTerm);
            });
        }
        
        if (tracksToRender.length === 0) {
            playlistElement.innerHTML = '<li style="padding: 10px; color: #999; text-align: center;">æœªæ‰¾åˆ°åŒ¹é…çš„æ­Œæ›²ã€‚è¯·å°è¯•å…¶ä»–å…³é”®è¯ã€‚</li>';
            return;
        }

        tracksToRender.forEach(track => {
            const listItem = document.createElement('li');
            listItem.className = 'playlist-item';
            listItem.setAttribute('data-fullfilename', track.fullFileName); 
            
            const formatHint = track.extension ? ` <span style="font-size: 0.8em; color: #00796b; opacity: 0.8;">(${track.extension.toUpperCase().slice(1)})</span>` : '';

            listItem.innerHTML = `
                <span class="song-title-display">${track.title}</span>
                <span class="song-artist-display">â€“ ${track.artist}${formatHint}</span>
            `;
            
            listItem.addEventListener('click', () => {
                loadAndPlayTrack(track);
            });

            if (track.fullFileName === currentTrackFullFileName) {
                 listItem.classList.add('active');
            }

            playlistElement.appendChild(listItem);
        });
    }
    
    /** æœç´¢ Debounce/å»æŠ–åŠ¨ å¤„ç†å‡½æ•° */
    function handleSearch(event) {
        const searchTerm = searchInput.value.trim();
        
        if (searchTerm === '' && searchTimeout !== null) { 
            clearTimeout(searchTimeout);
            searchTimeout = null;
            renderSearchResults(searchTerm);
            return;
        }
        
        clearTimeout(searchTimeout);
        searchTimeout = setTimeout(() => {
            renderSearchResults(searchTerm);
        }, 300);
    }


    // ====================================================
    // 7. æ•°æ®åŠ è½½å’Œåˆå§‹åŒ–
    // ====================================================

    async function fetchTrackList() {
        currentTitleElement.textContent = 'æ­£åœ¨è·å–æ­Œæ›²åˆ—è¡¨...';
        currentArtistElement.textContent = 'è¯·ç¨å€™';
        playlistElement.innerHTML = '<li style="padding: 10px; color: #00796b; text-align: center;">æ­£åœ¨ä» GitHub API è·å–æ–‡ä»¶åˆ—è¡¨...</li>';
        
        try {
            const response = await fetch(GITHUB_API_URL);

            if (!response.ok) {
                if (response.status === 404) {
                    throw new Error(`æ— æ³•æ‰¾åˆ° 'downloads' ç›®å½•åœ¨ä»“åº“ï¼š${REPO_OWNER}/${REPO_NAME}/${GITHUB_MAIN_BRANCH}ã€‚è¯·ç¡®è®¤è·¯å¾„ã€‚`);
                }
                throw new Error(`GitHub API é”™è¯¯: ${response.status} (${response.statusText}). å¯èƒ½æ˜¯ API é€Ÿç‡é™åˆ¶ã€‚`);
            }

            const data = await response.json();
            
            KnownTracks = data
                .filter(item => item.type === 'file' && 
                       SUPPORTED_EXTENSIONS.some(ext => item.name.toLowerCase().endsWith(ext)))
                .map(item => parseFileName(item.name));
            
            KnownTracks.sort((a,b) => a.title.localeCompare(b.title, 'zh-CN')); // æŒ‰æ ‡é¢˜æ’åº

            isListLoaded = true;

            currentTitleElement.textContent = `æ­Œæ›²åˆ—è¡¨åŠ è½½æˆåŠŸ (å…± ${KnownTracks.length} é¦–)`;
            currentArtistElement.textContent = 'è¾“å…¥å…³é”®è¯æœç´¢æˆ–ç‚¹å‡»æ­Œæ›²æ’­æ”¾';

            renderSearchResults(''); 
            
            if (KnownTracks.length > 0) {
                 loadAndPlayTrack(KnownTracks[0]);
                 audioPlayer.pause(); 
                 currentArtistElement.textContent = `[${KnownTracks[0].artist}]`;
            } else {
                 currentTitleElement.textContent = "æ‚¨çš„ä»“åº“ä¸­æš‚æ— æ­Œæ›²æ–‡ä»¶";
                 currentArtistElement.textContent = "è¯·åœ¨ 'downloads' ç›®å½•ä¸‹æ‰‹åŠ¨ä¸Šä¼ æ­Œæ›²ã€‚";
                 lyricsBox.innerHTML = '<p style="color:#999;">è¯·æ‰‹åŠ¨ä¸Šä¼ æ­Œæ›²åˆ° GitHub ä»“åº“çš„ downloads ç›®å½•ã€‚</p>';
            }

        } catch (error) {
            console.error("åŠ è½½æ­Œæ›²åˆ—è¡¨å¤±è´¥:", error);
            isListLoaded = false;
            currentTitleElement.textContent = 'åŠ è½½å¤±è´¥';
            currentArtistElement.textContent = `é”™è¯¯: ${error.message}`;
            playlistElement.innerHTML = `<li style="padding: 10px; color: red;">æ— æ³•è·å–æ­Œæ›²åˆ—è¡¨ï¼š${error.message}</li>`;
        }
    }


    // ====================================================
    // 8. äº‹ä»¶å¤„ç†å’Œåˆå§‹åŒ–
    // ====================================================

    function init() {
        searchInput.value = '';
        
        searchInput.addEventListener('keyup', handleSearch);
        
        shuffleBtn.addEventListener('click', toggleShuffleMode);
        loopBtn.addEventListener('click', toggleLoopMode); 
        prevBtn.addEventListener('click', playPrevTrack);
        nextBtn.addEventListener('click', playNextTrack);

        audioPlayer.addEventListener('timeupdate', syncLyrics); 

        audioPlayer.addEventListener('ended', () => {
            if (playMode === 'loop-one') {
                audioPlayer.currentTime = 0;
                audioPlayer.play();
                currentLyricIndex = -1; 
                renderLyricsHTML(); 
                return;
            }
            playNextTrack(); 
        });

        fetchTrackList(); 
        
        playMode = 'default'; 
        updateControlsDisplay();
    }

    init();
</script>

</body>
</html>
